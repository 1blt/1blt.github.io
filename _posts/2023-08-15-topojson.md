---
layout: post
title: Exploring and Splitting TopoJSONs
date: 2023-08-15 09:00:00
description: Investigating how to compress and lazily load geographic datasets using TopoJSON for scalable visualization.
tags: code data
categories: research-log
featured: false
---

## Appetizer
Client was interested in visualizing national datasets, but the current
software package has trouble display all that information at once.

## Appetite
Explore feasability for using [TopoJSON](https://github.com/topojson/topojson) to reduce size of the GeoJSON and incrementally load the geographic datasets.


## Aftertaste
Successfully converted a GeoJSON to a TopoJSON:

```bash
# Creating a topojson file
geo2topo 01001_bgct.geojson > 01001_bgct.topojson
```

Achieved ~75% reduction in file size between GeoJSON and TopoJSON for Virginia:

```python
# Calculating size differences between geojson and topojson
size_reduction = (128.7 - 30.9) / 128.7
# 0.7599067599067598
```

TopoJSONs generate arcs that each object references by index. One TopoJSON is not necessarily translatable across different geometries unless its reference index is global across files.  

This means **incremental loading is possible**, as long as:
- The global file of arcs is built first.
- Empty containers and indices not referenced for the current resolution are left in place and filled lazily as needed.

```python
# What do arc references look like?
{
    'type': 'Topology',
    'objects': {
    '01001_bgct': {
        'type': 'GeometryCollection',
        'geometries': [{
        'type': 'Polygon',
        'arcs': [[-2424, 149, -2423, 151, 145, 3280, -2511, 2694, 2487, -626, 2488,
                    -1396, 3196, 3197, -2344, -1301, 3064, 3073, 3506, 3510, 3512, 3515, ...]]
        }]
    }
    },
    'bbox': [-86.921237, 32.307574, -86.411172, 32.708213]
}
```

We can take advantage of the built-in bounding box to write an oracle function to load data based on the visible viewport.

If we remove unused arcs in the TopoJSON, the file can still render:

```python
# Unused arcs still render
req_arcs = [abs(i) for i in test_remainder[0]['arcs'][0]]

for i in range(len(j3['arcs'])):
    if i not in req_arcs:
        j3['arcs'][i] = []  # Empty values for unused arcs, fill in later

with open('../data/testing/01001_bgct_mod.topojson', 'w') as f:
    json.dump(j3, f)
os.path.isfile('../data/testing/01001_bgct_mod.topojson')
```

>A topojson is still valid if there are empty containers inside the arc lists

The TopoJSON can only be $$\leq$$ GeoJSON in size because arcs can be reused across geometries.  

On testing real files, arcs can be used up to 4 times between geometries:

```python
# Counting arc use across geometries
from collections import Counter
from tqdm import tqdm

c = Counter()
for geo in tqdm(j4['objects']['va_combined']['geometries']):
    li = geo['arcs']
    flatten = lambda l: sum(map(flatten, l), []) if isinstance(l, list) else [l]
    c += Counter(flatten(li))

'''
Counter({
    0: 4, 1: 4, 2: 4, ..., 924: 3, 925: 3, ...
})
'''
```
